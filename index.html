<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Figma-in-a-tag: Tailwind Edition</title>
</head>
<body class="p-10">
    <div style="background-color: red; width: 500px; height: 500px; color: white;">
        I am legacy code. Nuke me.
    </div>

    <script>
        (function() {
            // --- CONSTANTS ---
            const TAILWIND_CDN = 'https://cdn.tailwindcss.com';
            
            // --- PHASE 1: THE NUKE & INSTALL ---
            function initializeEnvironment() {
                console.log("âš™ï¸ Initializing Environment...");
                
                // 1. Check for Tailwind
                let hasTailwind = false;
                document.querySelectorAll('script').forEach(s => {
                    if (s.src.includes('tailwindcss')) hasTailwind = true;
                });

                if (!hasTailwind) {
                    console.log("â˜¢ï¸ No Tailwind detected. Initiating Nuke Protocol...");
                    nukeStyles();
                    injectTailwind();
                } else {
                    console.log("âœ… Tailwind detected. Extending environment.");
                }
            }

            function nukeStyles() {
                // Disable all existing stylesheets
                document.querySelectorAll('link[rel="stylesheet"], style').forEach(el => {
                    el.disabled = true;
                    // We don't remove them to avoid breaking script references, just disable visual impact
                });

                // Strip inline styles from ALL body elements
                const allElements = document.body.getElementsByTagName("*");
                for (let el of allElements) {
                    el.removeAttribute("style");
                }
                // Strip body style too
                document.body.removeAttribute("style");
            }

            function injectTailwind() {
                const script = document.createElement('script');
                script.src = TAILWIND_CDN;
                script.onload = () => console.log("ðŸŽ¨ Tailwind Installed & Ready.");
                document.head.appendChild(script);
            }

            // Run Initialization
            initializeEnvironment();


            // --- PHASE 2: THE EDITOR UI (Tailwind Native) ---
            
            let mouseX = 0, mouseY = 0;
            let selectedElement = null;

            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            // --- MENU CREATION LOGIC ---
            function createMenu(x, y, content) {
                // Remove existing
                const existing = document.getElementById('proto-menu');
                if (existing) existing.remove();

                const menu = document.createElement('div');
                menu.id = 'proto-menu';
                
                // UI RULE 1: Fixed Position, Max Z-Index
                // UI RULE 2: Tailwind Styling
                menu.className = `fixed z-[2147483647] top-[${y}px] left-[${x}px] bg-white border border-gray-300 shadow-xl rounded-md flex flex-col min-w-[200px] p-2 font-sans text-sm`;
                
                // Manual fix for dynamic top/left since Tailwind JIT might not pick up variable strings immediately in a raw script injection context
                // We use inline style ONLY for positioning the menu itself (allowed exception for UI overlays)
                menu.style.top = `${y}px`;
                menu.style.left = `${x}px`;

                content.forEach(item => menu.appendChild(item));
                document.body.appendChild(menu);
            }

            // --- RIGHT CLICK: PROPERTY EDITOR ---
            document.addEventListener('contextmenu', (e) => {
                if (!selectedElement) return;
                e.preventDefault();

                // Helper to create inputs
                const createRow = (label, type, getter, setter, options = []) => {
                    const row = document.createElement('div');
                    row.className = "flex justify-between items-center my-1";
                    
                    const lbl = document.createElement('span');
                    lbl.className = "text-gray-600 mr-2";
                    lbl.innerText = label;

                    let input;
                    if (type === 'select') {
                        input = document.createElement('select');
                        input.className = "border border-gray-300 rounded px-1 py-0.5 w-24 text-xs";
                        options.forEach(opt => {
                            const o = document.createElement('option');
                            o.value = opt;
                            o.innerText = opt;
                            input.appendChild(o);
                        });
                        input.value = getter(); 
                        input.onchange = () => setter(input.value);
                    } else {
                        input = document.createElement('input');
                        input.type = 'text';
                        input.className = "border border-gray-300 rounded px-1 py-0.5 w-20 text-xs";
                        input.value = getter();
                        input.oninput = () => setter(input.value);
                    }

                    row.appendChild(lbl);
                    row.appendChild(input);
                    return row;
                };

                const items = [];
                const tag = selectedElement.tagName;
                const cls = selectedElement.classList;

                // Here we would implement the "Class Mapper" logic later.
                // For now, we still edit styles directly or append utility classes blindly.
                // To keep it strictly Tailwind, we should technically parse the classList.
                // For this prototype step, we will use Arbitrary Values `w-[...]` to enforce Tailwind syntax.

                // Example: Width Editor using Tailwind Arbitrary Values
                items.push(createRow('Width', 'text', 
                    () => selectedElement.style.width || '', // Simple fallback for now
                    (val) => { 
                        // Remove existing w- classes
                        selectedElement.className = selectedElement.className.replace(/w-\[.*?\]/g, '').replace(/w-\S+/g, ''); 
                        // Add new arbitrary class
                        selectedElement.classList.add(`w-[${val}]`);
                    }
                ));
                
                // Example: Bg Color
                if (tag === 'DIV') {
                     items.push(createRow('Bg Color', 'text', 
                        () => '', // Hard to read back from class without parser
                        (val) => {
                             selectedElement.classList.add(`bg-[${val}]`);
                        }
                    ));
                }

                // Delete Button
                const delBtn = document.createElement('button');
                delBtn.innerText = "Delete";
                delBtn.className = "mt-2 bg-red-50 text-red-600 border border-red-200 rounded px-2 py-1 text-xs hover:bg-red-100";
                delBtn.onclick = () => {
                    if(confirm("Delete?")) { selectedElement.remove(); document.getElementById('proto-menu').remove(); }
                };
                items.push(delBtn);

                createMenu(e.clientX, e.clientY, items);
            });

            // --- SHIFT+A: CREATION MENU ---
            document.addEventListener('keydown', (e) => {
                if (e.shiftKey && e.key.toLowerCase() === 'a') {
                    const items = ['div', 'text', 'img'].map(opt => {
                        const btn = document.createElement('button');
                        btn.innerText = opt.toUpperCase();
                        btn.className = "w-full text-left px-2 py-1 hover:bg-gray-100 rounded text-gray-700 capitalize";
                        btn.onclick = () => {
                            let newEl;
                            if (opt === 'div') {
                                newEl = document.createElement('div');
                                // RULE 2: Default Tailwind Classes
                                newEl.className = "min-w-[100px] min-h-[100px] bg-gray-100 border border-dashed border-gray-400 m-2 flex flex-col p-2";
                            } else if (opt === 'text') {
                                newEl = document.createElement('h1');
                                newEl.innerText = "New Heading";
                                newEl.className = "text-2xl font-bold text-gray-800 p-2 m-2";
                            } else if (opt === 'img') {
                                newEl = document.createElement('img');
                                newEl.src = "https://via.placeholder.com/150";
                                newEl.className = "w-[150px] p-2 m-2";
                            }

                            // Selection Logic
                            newEl.addEventListener('click', (ev) => {
                                ev.stopPropagation();
                                const menu = document.getElementById('proto-menu');
                                if (menu) menu.remove();

                                if (selectedElement) selectedElement.classList.remove('outline', 'outline-2', 'outline-blue-500');
                                
                                selectedElement = newEl;
                                selectedElement.classList.add('outline', 'outline-2', 'outline-blue-500');
                            });

                            const parent = selectedElement || document.body;
                            parent.appendChild(newEl);
                            document.getElementById('proto-menu').remove();
                        };
                        return btn;
                    });
                    createMenu(mouseX, mouseY, items);
                }

                // Global Cancel
                if (e.key === 'Escape') {
                    const menu = document.getElementById('proto-menu');
                    if (menu) menu.remove();
                    if (selectedElement) {
                        selectedElement.classList.remove('outline', 'outline-2', 'outline-blue-500');
                        selectedElement = null;
                    }
                }
            });

        })();
    </script>
</body>
</html>